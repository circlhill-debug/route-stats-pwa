<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Progressive Web App metadata -->
<meta name="theme-color" content="#2b7fff" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="RouteStats" />
<title>Route Stats â€” Live Dashboard</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-180.png">
<script src="sw-register.js"></script>
<style>
  /* ... [CSS unchanged for brevity] ... */
</style>
</head>
<body>
<div id="diag">
  ROUTE STATS Â· Supabase: <b id="dConn">â€¦</b> Â· Auth: <b id="dAuth">â€¦</b> Â· Write: <b id="dWrite">â€”</b>
</div>

<!-- Version tag -->
<div style="position:fixed;top:6px;right:12px;color:#9aa0aa;font-size:11px;z-index:9999;">
  v2025-08-27-patched+setpw
</div>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <h1>ðŸ“ˆ ROUTE STATS â€” Live Dashboard â€” <span id="headerDate">â€”</span></h1>
    <div class="row">
      <button id="signInBtn" class="ghost">Sign in</button>
      <button id="setPwBtn" class="ghost" title="Set/Change password for the current account">Set password</button>
      <button id="linkBtn" class="ghost">Link devices (magic link)</button>
      <button id="signOut" class="ghost">Sign out</button>
    </div>
  </div>
</header>

<main class="wrap grid grid-2">
  <!-- ... [UI unchanged for brevity] ... -->
</main>

<!-- ... [Dialogs unchanged for brevity] ... -->

<button class="fab" id="fab">+ Add Entry</button>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script>
  // ... [start unchanged] ...

  // PATCH: FIX: define loadByDate and fetchEntries FIRST so they're available for all code blocks
  async function fetchEntries(){
    const { data:{ user } } = await sb.auth.getUser(); if(!user) return [];
    const { data, error } = await sb.from('entries').select('*').eq('user_id',user.id).order('work_date',{ascending:false}).limit(365);
    if(error){ console.error(error); return []; } return data;
  }

  async function loadByDate(){
    editingKey = null; const { data:{ user } } = await sb.auth.getUser(); if(!user) return; const d=date.value; if(!d) return;
    const { data, error } = await sb.from('entries').select('*').eq('user_id', user.id).eq('work_date', d).limit(1).maybeSingle();
    if (error && error.code !== 'PGRST116') { console.error(error); return; }
    const saveBtn=$('save'); saveBtn.classList.remove('ghost');
    if (data) { editingKey = { user_id:user.id, work_date:d }; fillForm(data); saveBtn.textContent='Update'; }
    else { saveBtn.textContent='Save'; }
  }

  // ... [rest of JS unchanged, but REMOVE any duplicate definitions of fetchEntries or loadByDate] ...

  // PATCH: refresh UI after auth state restores so form pre-fills
  sb.auth.onAuthStateChange(async (_evt, session) => {
    const authed = !!session;
    const signOutBtn = $('signOut');
    if (signOutBtn) signOutBtn.style.display = authed ? 'inline-block' : 'none';
    dAuth.textContent = authed ? 'Session' : 'No session';
    if (authed) {
      await loadByDate?.(); // Now always defined
      const rows = await fetchEntries?.();
      if (rows) {
        allRows = rows;
        renderTable(applySearch(allRows));
        buildCharts?.(allRows);
        buildSnapshot?.(allRows);
      }
    }
  });

  // ... [rest unchanged] ...
  date.addEventListener('change', loadByDate);

  // ... [rest unchanged] ...

  (async()=>{
    $('date').value=todayStr(); await loadByDate(); const rows=await fetchEntries(); allRows=rows; renderTable(applySearch(allRows)); buildCharts(allRows); buildSnapshot(allRows); computeBreakdown();
  })();

  console.log('Route Stats loaded â€” v2025-08-27-patched+setpw');
</script>
<!-- ... [service worker and error surfaces unchanged] ... -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').catch(function(err) {
        console.error('Service worker registration failed:', err);
      });
    });
  }
</script>
</body>
</html>