<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- PWA meta -->
<meta name="theme-color" content="#2b7fff" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="RouteStats" />
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-180.png">

<title>Route Stats — Live Dashboard</title>
<style>
  :root{
    --bg:#0f1115; --card:#141821; --border:#22262e; --text:#e8e8ea; --muted:#9aa0aa; --brand:#2b7fff;
    --good:#7CE38B; --warn:#FFD27A; --bad:#FF8FA1
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif }
  header{ border-bottom:1px solid var(--border); padding:14px 16px }
  .wrap{ max-width:1180px; margin:0 auto; padding:16px }
  h1{ margin:0; font-size:20px; letter-spacing:.3px }
  .grid{ display:grid; gap:12px }
  @media(min-width:1000px){ .grid-2{ grid-template-columns:1.2fr .8fr } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
  label{ font-size:13px; color:var(--muted) }
  input,select,textarea{ width:100%; padding:12px; background:transparent; border:1px solid var(--border);
    border-radius:10px; color:var(--text); font-size:15px }
  button{ background:var(--brand); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer }
  button.ghost{ background:transparent; color:var(--text); border:1px solid var(--border) }
  small{ color:var(--muted) }
  table{ width:100%; border-collapse:collapse }
  th,td{ border-bottom:1px solid var(--border); padding:8px 6px; text-align:left }
  th{ color:var(--muted); font-weight:600 }
  .right{ text-align:right }
  .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--border); padding:6px 8px;
    border-radius:999px; background:transparent }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  dialog{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:16px }
  .fab{ position:fixed; right:16px; bottom:16px; z-index:10 }
  #diag{ position:sticky; top:0; z-index:999; background:#111; color:#ddd; font:12px/1.35 system-ui; padding:6px 10px; border-bottom:1px solid #222 }
  #diag b{ color:#fff }
  tr.light td{ background:linear-gradient(90deg, rgba(124,227,139,.07), transparent) }
  tr.heavy td{ background:linear-gradient(90deg, rgba(255,143,161,.10), transparent) }
  tr.typical td{ background:linear-gradient(90deg, rgba(255,210,122,.08), transparent) }
</style>
</head>
<body>
<div id="diag">
  ROUTE STATS · Supabase: <b id="dConn">…</b> · Auth: <b id="dAuth">…</b> · Version: <b>v2025-08-27-fullfix</b>
</div>

<header>
  <div class="wrap row" style="justify-content:space-between">
    <h1>📈 ROUTE STATS — Live Dashboard — <span id="headerDate">—</span></h1>
    <div class="row">
      <button id="signInBtn" class="ghost">Sign in</button>
      <button id="setPwBtn" class="ghost" title="Set/Change password for the current account">Set password</button>
      <button id="linkBtn" class="ghost">Link devices</button>
      <button id="signOut" class="ghost" style="display:none">Sign out</button>
    </div>
  </div>
</header>

<main class="wrap grid grid-2">
  <!-- Snapshot -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start;flex-wrap:wrap">
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="pill"><small>Week Hours</small> <b id="wkHours">—</b> <span id="wkHoursDelta" class="pill">—</span></div>
        <div class="pill"><small>Week Parcels</small> <b id="wkParcels">—</b> <span id="wkParcelsDelta" class="pill">—</span></div>
        <div class="pill"><small>Week Letters</small> <b id="wkLetters">—</b> <span id="wkLettersDelta" class="pill">—</span></div>
      </div>
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="pill"><small>Today Parcels Δ</small> <b id="todayParcelsDelta">—</b></div>
        <div class="pill"><small>Today Letters Δ</small> <b id="todayLettersDelta">—</b></div>
      </div>
    </div>
  </section>

  <!-- Form -->
  <section class="card">
    <h3 style="margin:0 0 8px 0">Add Entry</h3>
    <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px">
      <div><label>Date</label><input id="date" type="date"></div>
      <div><label>Route</label><input id="route" type="text" value="R1" readonly></div>

      <div><label>Start</label><input id="start" type="time" value="08:00"></div>
      <div><label>Hit Street</label><input id="departTime" type="time" placeholder="--:--"></div>

      <div><label>Return</label><input id="returnTime" type="time" placeholder="--:--"></div>
      <div><label>Clock Out</label><input id="end" type="time" placeholder="--:--"></div>

      <div><label>Parcels</label><input id="parcels" type="number" min="0" value="0"></div>
      <div><label>Letters</label><input id="letters" type="number" min="0" value="0"></div>

      <div><label>Miles</label><input id="miles" type="number" step="0.1" min="0" value="0"></div>
      <div>
        <label>Weather</label>
        <select id="weather">
          <option value="">—</option><option>☀️ Sunny</option><option>⛅ Partly Cloudy</option>
          <option>🌧️ Rain</option><option>❄️ Snow</option><option>💨 Windy</option><option>🌫️ Fog</option><option>Other</option>
        </select>
      </div>

      <div><label>Temp (°F)</label><input id="temp" type="number" step="1" min="-40" max="130"></div>
      <div><label>Box holders</label>
        <select id="boxholders">
          <option value="">—</option><option>None</option><option>Light</option><option>Medium</option><option>Heavy</option>
        </select>
      </div>

      <div><label>Mood</label><select id="mood"><option value="">—</option><option>🔥 dialed in</option><option>🙂 good</option><option>😐 meh</option><option>🥵 cooked</option><option>🌧️ soggy</option><option>🛑 off</option></select></div>
      <div style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="2" placeholder="Anything notable…"></textarea></div>

      <div class="row" style="grid-column:1/-1;justify-content:space-between;align-items:center">
        <label class="pill"><input id="offDay" type="checkbox"> Off day</label>
        <div class="row"><span class="pill"><small>Office:</small> <b id="officeH">—</b></span><span class="pill"><small>Route:</small> <b id="routeH">—</b></span><span class="pill"><small>Total:</small> <b id="totalH">—</b></span></div>
        <div class="row"><button id="save">Save</button></div>
      </div>
    </div>
  </section>

  <!-- Table -->
  <section class="card" style="grid-column:1/-1">
    <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Recent Entries</h3>
      <div class="row" style="gap:8px">
        <input id="searchBox" type="search" placeholder="Search date, mood, weather, notes…" style="min-width:260px">
        <button id="exportCsv" class="ghost">Export CSV (All)</button>
        <button id="exportCsvFiltered" class="ghost">Export CSV (Filtered)</button>
        <input id="importFile" type="file" accept=".csv,text/csv" style="display:none">
        <button id="importCsv" class="ghost">Import CSV</button>
        <button id="showUid" class="ghost" title="Show current user id">Show UID</button>
      </div>
    </div>
    <div style="max-height:380px;overflow:auto;border:1px solid var(--border);border-radius:10px">
      <table id="tbl"><thead><tr>
        <th>Date</th><th>Route</th><th>Status</th><th class="right">Office (h)</th><th class="right">Route (h)</th>
        <th class="right">Total (h)</th><th class="right">Parcels</th><th class="right">Letters</th><th class="right">Miles</th><th>Weather</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>
</main>

<!-- Dialogs -->
<dialog id="linkDlg"><form method="dialog" class="grid" style="min-width:320px;gap:10px">
  <h3 style="margin:0">Link devices</h3>
  <small>Enter your email, then tap the magic link in your inbox on each device.</small>
  <input id="email" type="email" placeholder="you@example.com" required>
  <div class="row" style="justify-content:flex-end;gap:8px"><button class="ghost" value="cancel">Cancel</button><button id="sendLink">Send link</button></div>
</form></dialog>

<dialog id="pwDlg"><form method="dialog" class="grid" style="min-width:320px;gap:10px">
  <h3 style="margin:0">Sign in</h3>
  <input id="loginEmail" type="email" placeholder="Email" autocomplete="username" required>
  <input id="loginPass"  type="password" placeholder="Password" autocomplete="current-password" required>
  <div class="row" style="justify-content:flex-end;gap:8px">
    <button class="ghost" value="cancel">Cancel</button>
    <button id="doLogin">Sign In</button>
    <button id="doSignup" class="ghost" type="button" title="Create a new account">Create Account</button>
  </div>
  <small id="authMsg"></small>
</form></dialog>

<button class="fab" id="fab">+ Add Entry</button>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Header date + helpers -->
<script>
const ZONE = 'America/Detroit';
const DateTime = luxon.DateTime;
document.getElementById('headerDate').textContent = DateTime.now().setZone(ZONE).toFormat('MMM d, yyyy');
const $ = id => document.getElementById(id);
function todayStr(){ return DateTime.now().setZone(ZONE).toISODate(); }
function hhmmNow(){ const d = DateTime.now().setZone(ZONE); return `${String(d.hour).padStart(2,'0')}:${String(d.minute).padStart(2,'0')}`; }
function diffHours(d, t1, t2){
  if(!t1||!t2) return null;
  const a = DateTime.fromISO(`${d}T${t1}`, { zone: ZONE });
  const b = DateTime.fromISO(`${d}T${t2}`, { zone: ZONE });
  let h = (b.toMillis()-a.toMillis())/3.6e6; if(h<0) h+=24; return Math.round(h*100)/100;
}
function moonPhaseEmoji(dISO) {
  const lp = 2551443;
  const now = DateTime.fromISO(dISO, {zone: ZONE}).toSeconds();
  const ref = DateTime.fromISO("2001-01-01", {zone: ZONE}).toSeconds();
  const phase = ((now - ref) % lp) / lp;
  if (phase < 0.03 || phase > 0.97) return "🌑";
  if (phase < 0.25) return "🌒";
  if (phase < 0.27) return "🌓";
  if (phase < 0.48) return "🌔";
  if (phase < 0.52) return "🌕";
  if (phase < 0.75) return "🌖";
  if (phase < 0.77) return "🌗";
  return "🌘";
}
function dowLetter(dISO){ return DateTime.fromISO(dISO, {zone: ZONE}).toFormat('c') === '7' ? 'S' :
  DateTime.fromISO(dISO, {zone: ZONE}).toFormat('ccc').charAt(0); }
</script>

<!-- App + Supabase -->
<script>
const SUPABASE_URL  = 'https://ouwkdtiixkaydrtfdhnh.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91d2tkdGlpeGtheWRydGZkaG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDc0NDksImV4cCI6MjA3MDU4MzQ0OX0.KI-dYG5_A8jvPEHSog3wlnLbIGYIHQR_4ztXHL2SzIg';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true }});

const dConn=$('dConn'), dAuth=$('dAuth');

(async ()=>{ try{ await fetch(SUPABASE_URL,{mode:'no-cors'}); dConn.textContent='Connected'; }catch{ dConn.textContent='Error'; }})();

// BASIC DATA ACCESS
async function fetchEntries(){
  const { data:{ user } } = await sb.auth.getUser();
  if (!user) return [];
  const { data, error } = await sb.from('entries')
    .select('*')
    .eq('user_id', user.id)
    .order('work_date', { ascending:false })
    .limit(400);
  if (error) { console.warn(error); return []; }
  return data || [];
}

async function upsertEntry(row){
  const { data:{ user } } = await sb.auth.getUser();
  if (!user) throw new Error('No user');
  row.user_id = user.id;
  const { error } = await sb.from('entries').upsert(row).select().single();
  if (error) throw error;
}

// RENDER TABLE
function applySearch(rows){
  const q = ($('searchBox').value||'').trim().toLowerCase();
  if (!q) return rows;
  return rows.filter(r => {
    return (r.work_date||'').includes(q) || (r.mood||'').toLowerCase().includes(q)
      || (r.weather||'').toLowerCase().includes(q) || (r.notes||'').toLowerCase().includes(q);
  });
}

function renderTable(rows){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  for (const r of rows){
    const d = r.work_date;
    const dow = dowLetter(d);
    const moon = moonPhaseEmoji(d);
    const office = diffHours(d, r.start, r.depart_time||r.departTime) ?? 0;
    const routeH = diffHours(d, r.depart_time||r.departTime, r.end||r.return_time||r.returnTime) ?? 0;
    const total  = Math.round((office + routeH)*100)/100;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d} (${dow}) ${moon}</td>
      <td>${r.route||'R1'}</td>
      <td>${r.off_day? 'Off' : 'Worked'}</td>
      <td class="right">${office? office.toFixed(2) : '—'}</td>
      <td class="right">${routeH? routeH.toFixed(2) : '—'}</td>
      <td class="right">${total? total.toFixed(2) : '—'}</td>
      <td class="right">${r.parcels ?? ''}</td>
      <td class="right">${r.letters ?? ''}</td>
      <td class="right">${r.miles ?? ''}</td>
      <td>${r.weather || ''}</td>`;
    tb.appendChild(tr);
  }
}

// FORM PREFILL
async function loadByDate(){
  try{
    const dateEl = $('date');
    const d = (dateEl.value || todayStr());
    if (!dateEl.value) dateEl.value = d;

    const { data:{ user } } = await sb.auth.getUser();
    if (!user) return;

    const { data, error } = await sb
      .from('entries')
      .select('*')
      .eq('user_id', user.id)
      .eq('work_date', d).maybeSingle();

    if (error && error.code !== 'PGRST116'){ console.warn(error); return; }

    if (data){
      $('route').value      = data.route || 'R1';
      $('start').value      = data.start || '08:00';
      $('departTime').value = data.depart_time || data.departTime || '';
      $('returnTime').value = data.return_time || data.returnTime || '';
      $('end').value        = data.end || '';
      $('parcels').value    = data.parcels ?? 0;
      $('letters').value    = data.letters ?? 0;
      $('miles').value      = data.miles ?? 0;
      $('weather').value    = data.weather || '';
      $('temp').value       = data.temp || '';
      $('boxholders').value = data.boxholders || '';
      $('mood').value       = data.mood || '';
      $('notes').value      = data.notes || '';
      $('offDay').checked   = !!data.off_day || !!data.offDay;
    }else{
      // clears
      $('route').value='R1'; $('start').value='08:00';
      $('departTime').value=''; $('returnTime').value=''; $('end').value='';
      $('parcels').value=0; $('letters').value=0; $('miles').value=0;
      $('weather').value=''; $('temp').value=''; $('boxholders').value='';
      $('mood').value=''; $('notes').value=''; $('offDay').checked=false;
    }

    // compute preview
    const office = diffHours(d, $('start').value, $('departTime').value) ?? 0;
    const routeH = diffHours(d, $('departTime').value, $('end').value || $('returnTime').value) ?? 0;
    const total  = Math.round((office + routeH) * 100)/100;
    $('officeH').textContent = office? office.toFixed(2):'—';
    $('routeH').textContent  = routeH? routeH.toFixed(2):'—';
    $('totalH').textContent  = total? total.toFixed(2):'—';

  }catch(e){ console.warn('loadByDate error', e); }
}

// SAVE HANDLER
$('save').addEventListener('click', async ()=>{
  try{
    $('save').disabled = true; $('save').textContent='Saving…';
    const d = $('date').value || todayStr();
    await upsertEntry({
      work_date: d,
      route: $('route').value || 'R1',
      start: $('start').value || null,
      depart_time: $('departTime').value || null,
      return_time: $('returnTime').value || null,
      end: $('end').value || null,
      parcels: Number($('parcels').value||0),
      letters: Number($('letters').value||0),
      miles: Number($('miles').value||0),
      weather: $('weather').value || null,
      temp: $('temp').value || null,
      boxholders: $('boxholders').value || null,
      mood: $('mood').value || null,
      notes: $('notes').value || null,
      off_day: $('offDay').checked
    });
    await loadByDate();
    const rows = await fetchEntries();
    renderTable(applySearch(rows));
    $('save').textContent='Saved'; setTimeout(()=>{ $('save').textContent='Save'; },700);
  }catch(err){
    alert('Save failed: ' + (err?.message||err));
  }finally{
    $('save').disabled=false;
  }
});

// SEARCH
$('searchBox').addEventListener('input', async ()=>{
  const rows = await fetchEntries();
  renderTable(applySearch(rows));
});

// AUTH UI
const signInBtn = $('signInBtn');
const pwDlg     = $('pwDlg');
const loginEmail= $('loginEmail');
const loginPass = $('loginPass');
const doLogin   = $('doLogin');
const doSignup  = $('doSignup');
const authMsg   = $('authMsg');
const linkBtn=$('linkBtn'), linkDlg=$('linkDlg'), sendLink=$('sendLink'), email=$('email');

signInBtn?.addEventListener('click', ()=> {
  authMsg.textContent = '';
  loginEmail.value = loginEmail.value || '';
  loginPass.value = '';
  pwDlg.showModal();
});

linkBtn.addEventListener('click', ()=> linkDlg.showModal());
sendLink.addEventListener('click', async (e)=>{
  e.preventDefault();
  const redirectTo = location.origin + location.pathname;
  const { error } = await sb.auth.signInWithOtp({ email: email.value, options:{ emailRedirectTo: redirectTo } });
  if (error) alert(error.message); else { alert('Check your email for the magic link.'); linkDlg.close(); }
});

$('signOut').addEventListener('click', async ()=>{
  try { await sb.auth.signOut(); } catch {}
  location.reload();
});

doLogin?.addEventListener('click', async (e)=>{
  e.preventDefault();
  authMsg.textContent = 'Signing in…';
  const email = (loginEmail.value||'').trim();
  const password = loginPass.value||'';
  try {
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort('Timeout'), 12000);
    const { data, error } = await sb.auth.signInWithPassword({ email, password }, { signal: ctrl.signal });
    clearTimeout(t);
    if (error) {
      if (/Email not confirmed/i.test(error.message)) authMsg.textContent = 'Email not confirmed. Use reset link or check your inbox.';
      else if (/Invalid login credentials/i.test(error.message)) authMsg.textContent = 'Invalid email or password.';
      else authMsg.textContent = 'Error: ' + error.message;
      return;
    }
    authMsg.textContent = 'Signed in!';
    setTimeout(()=>{ try{ pwDlg.close(); }catch{}; }, 150);
    $('signOut').style.display='inline-block';
    dAuth.textContent='Session';
    // Prefill + render
    await loadByDate();
    const rows = await fetchEntries(); renderTable(applySearch(rows));
  } catch (err) {
    authMsg.textContent = (err && err.name==='AbortError') ? 'Network timeout. Try again.' : ('Error: ' + (err?.message||err));
  }
});

doSignup?.addEventListener('click', async ()=>{
  authMsg.textContent = 'Creating account…';
  const { error } = await sb.auth.signUp({
    email: (loginEmail.value||'').trim(),
    password: loginPass.value||''
  });
  authMsg.textContent = error
    ? ('Error: ' + error.message)
    : 'Account created. If email confirmation is on, check your inbox, then Sign In.';
});

// Session restore + auth-state changes
sb.auth.onAuthStateChange(async (_evt, session)=>{
  const authed = !!session;
  dAuth.textContent = authed ? 'Session' : 'No session';
  $('signOut').style.display = authed ? 'inline-block' : 'none';
  if (authed) {
    await loadByDate();
    const rows = await fetchEntries(); renderTable(applySearch(rows));
  }
});

// On load: date=today, try restore
document.addEventListener('DOMContentLoaded', async ()=>{
  $('date').value = todayStr();
  try{
    const { data:{ session } } = await sb.auth.getSession();
    if (session){
      dAuth.textContent='Session';
      $('signOut').style.display='inline-block';
      await loadByDate();
      const rows = await fetchEntries(); renderTable(applySearch(rows));
    } else {
      dAuth.textContent='No session';
    }
  }catch{}
  console.log('Route Stats loaded — v2025-08-27-fullfix');
});

// UID button
$('showUid').addEventListener('click', async (e)=>{
  e.preventDefault();
  try {
    let { data:{ session } } = await sb.auth.getSession();
    if (!session) {
      // small wait-and-retry
      let tries=0; while(!session && tries++<10){
        await new Promise(r=>setTimeout(r,150));
        ({ data:{ session } } = await sb.auth.getSession());
      }
    }
    if (!session) { alert('No session yet. Please Sign in first.'); return; }
    const { data:{ user } } = await sb.auth.getUser();
    if (!user) { alert('No session. Try signing in again.'); return; }
    alert(`Current user id (account key):\n${user.id}\n\nEntries are filtered by this id.`);
  } catch(e){ alert('Could not fetch user. Try signing in again.'); }
});

// Error surfacing
window.addEventListener('error', (ev) => {
  const diag = document.getElementById('diag'); if (!diag) return;
  const msg = (ev?.error?.message) || ev.message || String(ev);
  diag.innerHTML += ` · <b style="color:#ff8fa1">ERR</b>: ${msg}`;
});
window.addEventListener('unhandledrejection', (ev) => {
  const diag = document.getElementById('diag'); if (!diag) return;
  const msg = (ev?.reason?.message) || String(ev.reason);
  diag.innerHTML += ` · <b style="color:#ff8fa1">ERR</b>: ${msg}`;
});
</script>

<!-- Minimal SW register (your sw.js handles cache/versioning) -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').catch(function(err) {
      console.error('Service worker registration failed:', err);
    });
  });
}
</script>

</body>
</html>
