<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Progressive Web App metadata -->
<meta name="theme-color" content="#2b7fff" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="RouteStats" />
<title>Route Stats ‚Äî Live Dashboard</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-180.png">
<style>
  :root{
    --bg:#0f1115; --card:#141821; --border:#22262e; --text:#e8e8ea; --muted:#9aa0aa; --brand:#2b7fff;
    --good:#7CE38B; --warn:#FFD27A; --bad:#FF8FA1
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif }
  header{ border-bottom:1px solid var(--border); padding:14px 16px }
  .wrap{ max-width:1120px; margin:0 auto; padding:16px }
  h1{ margin:0; font-size:20px; letter-spacing:.3px }
  .grid{ display:grid; gap:12px }
  @media(min-width:1000px){ .grid-2{ grid-template-columns:1.1fr .9fr } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px }
  label{ font-size:13px; color:var(--muted) }
  input,select,textarea{ width:100%; padding:12px; background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--text); font-size:15px }
  button{ background:var(--brand); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer }
  button.ghost{ background:transparent; color:var(--text); border:1px solid var(--border) }
  small{ color:var(--muted) }
  table{ width:100%; border-collapse:collapse }
  th,td{ border-bottom:1px solid var(--border); padding:8px 6px; text-align:left }
  th{ color:var(--muted); font-weight:600 }
  .right{ text-align:right }
  .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--border); padding:6px 8px; border-radius:999px; background:transparent }
  .stat{ display:flex; flex-direction:column; gap:4px; padding:10px; border:1px solid var(--border); border-radius:12px; min-width:140px }
  .up{ color:var(--good) } .down{ color:var(--bad) } .warn{ color:var(--warn) }
  canvas{ background:transparent; border:1px solid var(--border); border-radius:10px; padding:8px }
  .fab{ position:fixed; right:16px; bottom:16px; z-index:10 }
  #diag{ position:sticky; top:0; z-index:999; background:#111; color:#ddd; font:12px/1.35 system-ui; padding:6px 10px; border-bottom:1px solid #222 }
  #diag b{ color:#fff }
  tr.light td{ background:linear-gradient(90deg, rgba(124,227,139,.07), transparent) }
  tr.heavy td{ background:linear-gradient(90deg, rgba(255,143,161,.10), transparent) }
  tr.typical td{ background:linear-gradient(90deg, rgba(255,210,122,.08), transparent) }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  dialog{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:16px }

  /* Visibility + focus upgrades */
  input,select,textarea{
    background:#0b0f15;
    border:1px solid #303643;
    font-size:16px;
    caret-color:var(--brand);
  }
  input:hover,select:hover,textarea:hover{ border-color:#3d4554 }
  input:focus-visible,select:focus-visible,textarea:focus-visible{
    outline:2px solid var(--brand);
    outline-offset:0;
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(43,127,255,.25);
    background:#0c1220;
  }
  ::placeholder{ color:#b7beca; opacity:1 }
  .card .grid > div:has(> input:focus-visible),
  .card .grid > div:has(> select:focus-visible),
  .card .grid > div:has(> textarea:focus-visible){
    background:#101726;
    border-radius:10px;
    padding:6px;
    transition:background .15s ease;
  }

  /* Save feedback */
  button.saving{ opacity:.7; cursor:wait }
  @keyframes savedFlash{
    0%{ box-shadow:0 0 0 0 rgba(43,127,255,.6) }
    100%{ box-shadow:0 0 0 14px rgba(43,127,255,0) }
  }
  button.savedFlash{ animation:savedFlash 600ms ease-out }

  /* Clickable results */
  #tbl tbody tr.rowLink{ cursor:pointer }
  #tbl tbody tr.rowLink:hover td{ background:rgba(43,127,255,.06) }
</style>
</head>
<body>
<div id="diag">
  ROUTE STATS ¬∑ Supabase: <b id="dConn">‚Ä¶</b> ¬∑ Auth: <b id="dAuth">‚Ä¶</b> ¬∑ Write: <b id="dWrite">‚Äî</b>
</div>

<!-- Version tag -->
<div style="position:fixed;top:6px;right:12px;color:#9aa0aa;font-size:11px;z-index:9999;">
  v2025-08-27-patched+setpw+fix1
</div>
<header>
  <div class="wrap row" style="justify-content:space-between">
    <h1>üìà ROUTE STATS ‚Äî Live Dashboard ‚Äî <span id="headerDate">‚Äî</span></h1>
    <div class="row">
      <button id="signInBtn" class="ghost">Sign in</button>
      <button id="setPwBtn" class="ghost" title="Set/Change password for the current account">Set password</button>
      <button id="linkBtn" class="ghost">Link devices (magic link)</button>
      <button id="signOut" class="ghost">Sign out</button>
    </div>
  </div>
</header>

<main class="wrap grid grid-2">
  <!-- SNAPSHOT -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start;flex-wrap:wrap">
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="stat">
          <small>Expected End (today)</small>
          <strong id="expEnd" style="font-size:20px">‚Äî</strong>
          <small id="expMeta" style="color:var(--muted)">DOW avg ‚Äî</small>
        </div>
        <div class="stat">
          <small>Volume</small>
          <strong id="badgeVolume" style="font-size:20px">‚Äî</strong>
          <small class="muted">parcels + 0.33√óletters</small>
        </div>
        <div class="stat">
          <small>Route Eff.</small>
          <strong id="badgeRouteEff" style="font-size:20px">‚Äî</strong>
          <small class="muted">vs weekday baseline</small>
        </div>
        <div class="stat">
          <small>Overall</small>
          <strong id="badgeOverall" style="font-size:20px">‚Äî</strong>
          <small class="muted">office + route vs expected</small>
        </div>
      </div>
      <div class="row" style="gap:8px;align-items:stretch">
        <div class="stat">
          <small>Hours (week)</small>
          <div><strong id="wkHours">‚Äî</strong> <span id="wkHoursDelta" class="pill">‚Äî</span></div>
        </div>
        <div class="stat">
          <small>Parcels (week)</small>
          <div><strong id="wkParcels">‚Äî</strong> <span id="wkParcelsDelta" class="pill">‚Äî</span></div>
        </div>
        <div class="stat">
          <small>Letters (week)</small>
          <div><strong id="wkLetters">‚Äî</strong> <span id="wkLettersDelta" class="pill">‚Äî</span></div>
        </div>
        <!-- Today vs same-weekday pills -->
        <div class="stat">
          <small>Today Parcels Œî</small>
          <div><strong id="todayParcelsDelta">‚Äî</strong></div>
          <small class="muted">vs past same weekday (worked)</small>
        </div>
        <div class="stat">
          <small>Today Letters Œî</small>
          <div><strong id="todayLettersDelta">‚Äî</strong></div>
          <small class="muted">vs past same weekday (worked)</small>
        </div>
      </div>
    </div>
  </section>

  <!-- FORM -->
  <section class="card">
    <h3 style="margin:0 0 8px 0">Add Entry</h3>

    <div class="row" style="margin:6px 0 10px 0; gap:8px; flex-wrap:wrap">
      <button id="btnStartNow" class="ghost">Start (now)</button>
      <button id="btnStreetNow" class="ghost">Hit Street (now)</button>
      <button id="btnClockNow" class="ghost">Clock Out (now)</button>
      <!-- Quick actions -->
      <button id="btnEditLast" class="ghost">Edit last entry</button>
      <button id="btnDeleteDay" class="ghost" style="border-color:#ff8fa1;color:#ff8fa1">Delete this day</button>
      <button id="btnUndoDelete" class="ghost" style="display:none">Undo delete</button>
    </div>

    <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px">
      <div><label>Date</label><input id="date" type="date"></div>

      <div>
        <label>Route</label>
        <input id="route" type="text" value="R1" readonly>
      </div>

      <div><label>Start (defaults 08:00)</label><div class="row"><input id="start" type="time" value="08:00"><button id="btnStartNow2" class="ghost">Now</button></div></div>
      <div><label>Hit Street</label><div class="row"><input id="departTime" type="time" placeholder="--:--"><button id="btnStreetNow2" class="ghost">Now</button></div></div>

      <div><label>Return (optional)</label><div class="row"><input id="returnTime" type="time" placeholder="--:--"><button id="btnReturnNow" class="ghost">Now</button></div></div>
      <div><label>Clock Out</label><div class="row"><input id="end" type="time" placeholder="--:--"><button id="btnClockNow2" class="ghost">Now</button></div></div>

      <div><label>Parcels</label><input id="parcels" type="number" min="0" value="0"></div>
      <div><label>Letters</label><input id="letters" type="number" min="0" value="0"></div>
      <div><label>Miles</label><input id="miles" type="number" step="0.1" min="0" value="0"></div>

      <div>
        <label>Weather</label>
        <div class="row">
          <select id="weather" style="min-width:160px">
            <option value="">‚Äî</option>
            <option>‚òÄÔ∏è Sunny</option>
            <option>‚õÖ Partly Cloudy</option>
            <option>üåßÔ∏è Rain</option>
            <option>‚ùÑÔ∏è Snow</option>
            <option>üí® Windy</option>
            <option>üå´Ô∏è Fog</option>
            <option>Other</option>
          </select>
          <select id="temp" title="Temp (¬∞F)" style="min-width:110px">
            <option value="">Temp (¬∞F)</option>
            <option>20</option><option>25</option><option>30</option><option>35</option>
            <option>40</option><option>45</option><option>50</option><option>55</option>
            <option>60</option><option>65</option><option>70</option><option>75</option>
            <option>80</option><option>85</option><option>90</option><option>95</option>
          </select>
        </div>
      </div>

      <div>
        <label>Box holders</label>
        <select id="boxholders">
          <option value="">‚Äî</option>
          <option>None</option>
          <option>Light</option>
          <option>Medium</option>
          <option>Heavy</option>
        </select>
      </div>

      <div><label>Mood</label><select id="mood"><option value="">‚Äî</option><option>üî• dialed in</option><option>üôÇ good</option><option>üòê meh</option><option>ü•µ cooked</option><option>üåßÔ∏è soggy</option><option>üõë off</option></select></div>
      <div style="grid-column:1/-1"><label>Notes</label><textarea id="notes" rows="2" placeholder="Anything notable‚Ä¶"></textarea></div>

      <div class="row" style="grid-column:1/-1;justify-content:space-between;align-items:center">
        <label class="pill"><input id="offDay" type="checkbox"> Off day</label>
        <div class="row"><span class="pill"><small>Office:</small> <b id="officeH">‚Äî</b></span><span class="pill"><small>Route:</small> <b id="routeH">‚Äî</b></span><span class="pill"><small>Total:</small> <b id="totalH">‚Äî</b></span></div>
        <div class="row"><button id="save">Save</button></div>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section class="card"><h3 style="margin:0 0 8px 0">Averages by Day of Week</h3><canvas id="dowChart" height="180"></canvas></section>
  <section class="card"><h3 style="margin:0 0 8px 0">Parcels Over Time (worked days)</h3><canvas id="parcelsChart" height="180"></canvas></section>
  <section class="card"><h3 style="margin:0 0 8px 0">Letters Over Time (worked days)</h3><canvas id="lettersChart" height="180"></canvas></section>

  <!-- TABLE -->
  <section class="card" style="grid-column:1/-1">
    <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
      <h3 style="margin:0">Recent Entries</h3>
      <div class="row" style="gap:8px">
        <input id="searchBox" type="search" placeholder="Search date, mood, weather, notes‚Ä¶" style="min-width:240px">
        <button id="exportCsv" class="ghost">Export CSV (All)</button>
        <button id="exportCsvFiltered" class="ghost">Export CSV (Filtered)</button>
        <input id="importFile" type="file" accept=".csv,text/csv" style="display:none">
        <button id="importCsv" class="ghost">Import CSV</button>
        <button id="showUid" class="ghost" title="Show current user id">Show UID</button>
      </div>
    </div>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px">
      <table id="tbl"><thead><tr>
        <th>Date</th><th>Route</th><th>Status</th><th class="right">Office (h)</th><th class="right">Route (h)</th><th class="right">Total (h)</th><th class="right">Parcels</th><th class="right">Letters</th><th class="right">Miles</th><th>Weather</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>
</main>

<!-- Magic link dialog -->
<dialog id="linkDlg">
  <form method="dialog" class="grid" style="min-width:320px;gap:10px">
    <h3 style="margin:0">Link devices</h3>
    <small>Enter your email, then tap the magic link in your inbox on each device.</small>
    <input id="email" type="email" placeholder="you@example.com" required>
    <div class="row" style="justify-content:flex-end;gap:8px"><button class="ghost" value="cancel">Cancel</button><button id="sendLink">Send link</button></div>
  </form>
</dialog>

<!-- Email + Password dialog -->
<dialog id="pwDlg">
  <form method="dialog" class="grid" style="min-width:320px;gap:10px">
    <h3 style="margin:0">Sign in</h3>
    <input id="loginEmail" type="email" placeholder="Email" autocomplete="username" required>
    <input id="loginPass"  type="password" placeholder="Password" autocomplete="current-password" required>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button class="ghost" value="cancel">Cancel</button>
      <button id="doLogin">Sign In</button>
      <button id="doSignup" class="ghost" type="button" title="Create a new account">Create Account</button>
    </div>
    <small id="authMsg"></small>
  </form>
</dialog>

<!-- Set Password dialog -->
<dialog id="setPwDlg">
  <form method="dialog" class="grid" style="min-width:320px;gap:10px">
    <h3 style="margin:0">Set a new password</h3>
    <input id="newPass"  type="password" placeholder="New password (6+ chars)" required>
    <input id="newPass2" type="password" placeholder="Confirm password" required>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button class="ghost" value="cancel">Cancel</button>
      <button id="doSetPw">Save</button>
    </div>
    <small id="setPwMsg"></small>
  </form>
</dialog>

<button class="fab" id="fab">+ Add Entry</button>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Header date (safe, balanced) -->
<script>
(function(){
  const ZONE = 'America/Detroit';
  const DateTime = luxon.DateTime;
  const el = document.getElementById('headerDate');
  if (el) el.textContent = DateTime.now().setZone(ZONE).toFormat('MMM d, yyyy');
})();
</script>

<!-- App + Auth (handlers and fixes) -->
<script>
/* ===== CONFIG + HELPERS ===== */
const SUPABASE_URL  = 'https://ouwkdtiixkaydrtfdhnh.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91d2tkdGlpeGtheWRydGZkaG5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDc0NDksImV4cCI6MjA3MDU4MzQ0OX0.KI-dYG5_A8jvPEHSog3wlnLbIGYIHQR_4ztXHL2SzIg';
const ZONE = 'America/Detroit';
const $ = id => document.getElementById(id);
const DateTime = luxon.DateTime;
const dConn=$('dConn'), dAuth=$('dAuth'), dWrite=$('dWrite');

function todayStr(){ return DateTime.now().setZone(ZONE).toISODate(); }
function hhmmNow(){ const d = DateTime.now().setZone(ZONE); return `${String(d.hour).padStart(2,'0')}:${String(d.minute).padStart(2,'0')}`; }
function diffHours(d, t1, t2){
  if(!t1||!t2) return null;
  const a = DateTime.fromISO(`${d}T${t1}`, { zone: ZONE });
  const b = DateTime.fromISO(`${d}T${t2}`, { zone: ZONE });
  let h = (b.toMillis()-a.toMillis())/3.6e6; if(h<0) h+=24; return Math.round(h*100)/100;
}
function routeEndTime(){ return ($('returnTime').value || $('end').value || ''); }
</script>

<!-- Add working loadByDate + safe fill/clear (so PWA doesn't crash) -->
<script>
  // Ensure global edit key exists
  if (typeof window.editingKey === 'undefined') window.editingKey = null;

  // Prefill the form for the selected date (or today)
  async function loadByDate(){
    try {
      const dateEl = $('date');
      const d = (dateEl?.value || todayStr());
      if (dateEl && !dateEl.value) dateEl.value = d;

      // Try to get user; if none, stop quietly
      const { data:{ user } } = await sb.auth.getUser();
      if (!user) return;

      const { data, error } = await sb
        .from('entries')
        .select('*')
        .eq('user_id', user.id)
        .eq('work_date', d)
        .limit(1)
        .maybeSingle();

      if (error && error.code !== 'PGRST116') { console.warn('loadByDate error:', error); return; }

      // Basic in-file fill/clear so we don't depend on external functions
      function fillForm(row){
        $('route').value      = row.route || 'R1';
        $('start').value      = row.start || '08:00';
        $('departTime').value = row.depart_time || row.departTime || '';
        $('returnTime').value = row.return_time || row.returnTime || '';
        $('end').value        = row.end || '';
        $('parcels').value    = row.parcels ?? 0;
        $('letters').value    = row.letters ?? 0;
        $('miles').value      = row.miles ?? 0;
        $('weather').value    = row.weather || '';
        $('temp').value       = row.temp || '';
        $('boxholders').value = row.boxholders || '';
        $('mood').value       = row.mood || '';
        $('notes').value      = row.notes || '';
        $('offDay').checked   = !!row.off_day || !!row.offDay;
        // Compute hours preview
        const office = diffHours(d, $('start').value, $('departTime').value) ?? 0;
        const routeH = diffHours(d, $('departTime').value, routeEndTime()) ?? 0;
        const total  = Math.round((office + routeH) * 100)/100;
        $('officeH').textContent = office ? office.toFixed(2) : '‚Äî';
        $('routeH').textContent  = routeH ? routeH.toFixed(2) : '‚Äî';
        $('totalH').textContent  = total  ? total.toFixed(2)  : '‚Äî';
      }
      function clearForm(){
        // Keep date as-is; reset the rest
        $('route').value      = 'R1';
        $('start').value      = '08:00';
        $('departTime').value = '';
        $('returnTime').value = '';
        $('end').value        = '';
        $('parcels').value    = 0;
        $('letters').value    = 0;
        $('miles').value      = 0;
        $('weather').value    = '';
        $('temp').value       = '';
        $('boxholders').value = '';
        $('mood').value       = '';
        $('notes').value      = '';
        $('offDay').checked   = false;
        $('officeH').textContent = '‚Äî';
        $('routeH').textContent  = '‚Äî';
        $('totalH').textContent  = '‚Äî';
      }

      const saveBtn = $('save');
      if (saveBtn) saveBtn.classList.remove('ghost');

      if (data) {
        window.editingKey = { user_id: user.id, work_date: d };
        fillForm(data);
        if (saveBtn) saveBtn.textContent = 'Update';
      } else {
        window.editingKey = null;
        clearForm();
        if (saveBtn) saveBtn.textContent = 'Save';
      }
    } catch (err) {
      console.warn('loadByDate exception:', err);
    }
  }
</script>

<!-- Supabase + Auth wiring -->
<script>
/* ===== SUPABASE CLIENT ===== */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true }});

// Auth callback (magic links / recovery)
(async () => {
  try {
    const { data, error } = await sb.auth.getSessionFromUrl();
    if (!error && data?.session && /type=recovery/i.test(location.hash)) {
      const p1 = prompt('Enter a new password (6+ characters)');
      if (p1 && p1.length >= 6) {
        const { error: uerr } = await sb.auth.updateUser({ password: p1 });
        if (uerr) alert('Update failed: ' + uerr.message);
        else alert('Password updated. You can now sign in normally.');
      } else {
        alert('Password must be at least 6 characters.');
      }
      window.history.replaceState({}, document.title, window.location.pathname);
    } else if (!error && data?.session) {
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  } catch (e) { console.warn('Auth callback error', e); }
})();

// Connectivity + session bootstrap
(async ()=>{ try{ await fetch(SUPABASE_URL,{mode:'no-cors'}); dConn.textContent='Connected'; }catch{ dConn.textContent='Error'; }})();
(async function ensureSession(){
  const { data:{ session } } = await sb.auth.getSession();
  if(!session){ try{ await sb.auth.signInAnonymously(); }catch{} }
  const { data:{ user } } = await sb.auth.getUser();
  dAuth.textContent = user? 'Session' : 'No session';
})();

/* ===== AUTH UI ===== */
const linkBtn=$('linkBtn'), linkDlg=$('linkDlg'), sendLink=$('sendLink'), email=$('email');
linkBtn.addEventListener('click', ()=> linkDlg.showModal());
sendLink.addEventListener('click', async (e)=>{
  e.preventDefault();
  const redirectTo = location.origin + location.pathname;
  const { error } = await sb.auth.signInWithOtp({ email: email.value, options:{ emailRedirectTo: redirectTo } });
  if (error) alert(error.message); else { alert('Check your email for the magic link.'); linkDlg.close(); }
});
$('signOut').addEventListener('click', ()=> sb.auth.signOut().then(()=>location.reload()));

const signInBtn = $('signInBtn');
const pwDlg     = $('pwDlg');
const loginEmail= $('loginEmail');
const loginPass = $('loginPass');
const doLogin   = $('doLogin');
const doSignup  = $('doSignup');
const authMsg   = $('authMsg');

signInBtn?.addEventListener('click', ()=> {
  authMsg.textContent = '';
  loginEmail.value = loginEmail.value || '';
  loginPass.value = '';
  pwDlg.showModal();
});

// Robust Sign In (waits for session)
doLogin?.addEventListener('click', async (e)=>{
  e.preventDefault();
  authMsg.textContent = 'Signing in‚Ä¶';
  const email = (loginEmail.value||'').trim();
  const password = loginPass.value||'';
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error) {
    if (/Email not confirmed/i.test(error.message)) authMsg.textContent = 'Email not confirmed. Use reset link or check your inbox.';
    else if (/Invalid login credentials/i.test(error.message)) authMsg.textContent = 'Invalid email or password. Try Reset or Create Account.';
    else authMsg.textContent = 'Error: ' + error.message;
    return;
  }
  let session = null, tries = 0;
  while (!session && tries++ < 10) {
    const r = await sb.auth.getSession();
    session = r?.data?.session || null;
    if (!session) await new Promise(r => setTimeout(r, 150));
  }
  authMsg.textContent = session ? 'Signed in!' : 'Signed in (pending session)‚Ä¶';
  pwDlg.close();

  // Refresh UI/data so the form pre-fills (tolerant calls)
  let rows = null;
  if (typeof fetchEntries === 'function') {
    try { rows = await fetchEntries(); } catch {}
  }
  if (rows && Array.isArray(rows)) {
    window.allRows = rows;
    if (typeof applySearch === 'function' && typeof renderTable === 'function') {
      try { renderTable(applySearch(rows)); } catch {}
    }
    if (typeof buildCharts === 'function')   try { buildCharts(rows); }   catch{}
    if (typeof buildSnapshot === 'function') try { buildSnapshot(rows); } catch{}
  }
  // Always try to prefill the form for today
  try { await loadByDate?.(); } catch {}
});

doSignup?.addEventListener('click', async ()=>{
  authMsg.textContent = 'Creating account‚Ä¶';
  const { error } = await sb.auth.signUp({
    email: (loginEmail.value||'').trim(),
    password: loginPass.value||''
  });
  authMsg.textContent = error
    ? ('Error: ' + error.message)
    : 'Account created. If email confirmation is on, check your inbox, then Sign In.';
});

// Set password for CURRENT user
const setPwBtn = $('setPwBtn');
const setPwDlg = $('setPwDlg');
const newPass  = $('newPass');
const newPass2 = $('newPass2');
const setPwMsg = $('setPwMsg');
const doSetPw  = $('doSetPw');

setPwBtn?.addEventListener('click', ()=> {
  setPwMsg.textContent = '';
  newPass.value = '';
  newPass2.value = '';
  setPwDlg.showModal();
});

doSetPw?.addEventListener('click', async (e)=>{
  e.preventDefault();
  const p1 = newPass.value || '';
  const p2 = newPass2.value || '';
  if (p1.length < 6) { setPwMsg.textContent = 'Password must be at least 6 characters.'; return; }
  if (p1 !== p2)     { setPwMsg.textContent = 'Passwords do not match.'; return; }
  setPwMsg.textContent = 'Updating‚Ä¶';
  const { error } = await sb.auth.updateUser({ password: p1 });
  if (error) { setPwMsg.textContent = 'Error: ' + error.message; return; }
  setPwMsg.textContent = 'Password set! You can now sign in anywhere.';
  setTimeout(()=> setPwDlg.close(), 600);
});

// Keep UI in sync on auth-state changes (tolerant)
sb.auth.onAuthStateChange(async (_evt, session) => {
  const authed = !!session;
  const signOutBtn = $('signOut');
  if (signOutBtn) signOutBtn.style.display = authed ? 'inline-block' : 'none';
  dAuth.textContent = authed ? 'Session' : 'No session';
  if (authed) {
    try { await loadByDate?.(); } catch {}
    let rows = null;
    if (typeof fetchEntries === 'function') {
      try { rows = await fetchEntries(); } catch {}
    }
    if (rows && Array.isArray(rows)) {
      window.allRows = rows;
      if (typeof applySearch === 'function' && typeof renderTable === 'function') {
        try { renderTable(applySearch(rows)); } catch {}
      }
      if (typeof buildCharts === 'function')   try { buildCharts(rows); }   catch{}
      if (typeof buildSnapshot === 'function') try { buildSnapshot(rows); } catch{}
    }
  }
});

console.log('Route Stats loaded ‚Äî v2025-08-27-patched+setpw+fix1');
</script>

<!-- Safety net: delegated wiring + error surfacing -->
<script>
document.addEventListener('click', async (e) => {
  const id = (e.target && e.target.id) || (e.target.closest && (e.target.closest('button')?.id));
  if (!id) return;

  if (id === 'signInBtn') {
    e.preventDefault();
    const dlg = document.getElementById('pwDlg');
    if (dlg && typeof dlg.showModal === 'function') dlg.showModal();
    else alert('Sign-in dialog not available on this browser.');
  }

  if (id === 'signOut') {
    e.preventDefault();
    try { await sb.auth.signOut(); } catch {}
    location.reload();
  }

  if (id === 'showUid') {
    e.preventDefault();
    try {
      let { data:{ session } } = await sb.auth.getSession();
      if (!session) {
        let tries = 0;
        while (!session && tries++ < 10) {
          await new Promise(r => setTimeout(r, 150));
          ({ data:{ session } } = await sb.auth.getSession());
        }
      }
      if (!session) { alert('No session yet. Please Sign in first.'); return; }
      const { data:{ user } } = await sb.auth.getUser();
      if (!user) { alert('No session. Try signing in again.'); return; }
      alert(`Current user id (account key):\n${user.id}\n\nEntries are filtered by this id.`);
    } catch {
      alert('Could not fetch user. Try signing in again.');
    }
  }
});

(function(){
  const diag = document.getElementById('diag');
  window.addEventListener('error', (ev) => {
    if (!diag) return;
    const msg = (ev?.error?.message) || ev.message || String(ev);
    diag.innerHTML += ` ¬∑ <b style="color:#ff8fa1">ERR</b>: ${msg}`;
  });
  window.addEventListener('unhandledrejection', (ev) => {
    if (!diag) return;
    const msg = (ev?.reason?.message) || String(ev.reason);
    diag.innerHTML += ` ¬∑ <b style="color:#ff8fa1">ERR</b>: ${msg}`;
  });
})();
</script>

<!-- Register the service worker for offline support -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').catch(function(err) {
      console.error('Service worker registration failed:', err);
    });
  });
}
</script>
</body>
</html>